(()=>{"use strict";var e={275:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0;const r=s(374);class a extends r.EventEmitter{constructor(){super(),this._clientData=null,this._origin={sandbox:"https://gadget.payment.qa.91dev.tw",production:"https://gadget.payment.91app.com"}}static getInstance(){return a._instance||(a._instance=new a),a._instance}set clientData(e){this._clientData=Object.assign({},e)}get clientData(){return this._clientData}get version(){return"2.0.0-alpha.4"}get origin(){return this._origin[this.clientData.serverType]}get apiDomain(){return this._origin[this.clientData.serverType]}get iframeDomain(){return`./${this.version}`}}t.Config=a},374:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmitter=void 0,t.EventEmitter=class{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach((e=>{e(t)}))}off(e){this.listeners.has(e)&&this.listeners.delete(e)}}},906:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PostMessageEmitter=void 0,t.PostMessageEmitter=class{constructor(e,t,s){this.current=e,this.target=t,this.origin=s,this.listeners=new Map,this.current.addEventListener("message",(e=>{const{type:t,payload:s}=e.data;this.listeners.get(t)&&this.listeners.get(t).forEach((e=>{e(s)}))}))}on(e,t){this.listeners.get(e)||this.listeners.set(e,[t])}emit(e,t){const s={type:e,payload:t};this.target.postMessage(s,this.origin)}registerEvent(e){return t=>this.on(e,t)}}},887:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.CardBrand=void 0,(s=t.CardBrand||(t.CardBrand={})).Unknown="Unknown",s.MasterCard="MasterCard",s.VISA="VISA",s.JCB="JCB",s.AMEX="AMEX",s.UnionPay="UnionPay"},540:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.convertSetupStylesToCSSRule=t.combineDefaultSetup=t.getCardCCVMaxLength=t.getCardNumberMaxLength=t.getCardBrand=void 0;const r=s(887);t.getCardBrand=e=>{const t={[r.CardBrand.AMEX]:/^3[47]/,[r.CardBrand.VISA]:/^4/,[r.CardBrand.MasterCard]:/^5[1-5]/,[r.CardBrand.JCB]:/^35/,[r.CardBrand.UnionPay]:/^62/};let s=r.CardBrand.Unknown;return Object.entries(t).forEach((([t,r])=>{r.test(e)&&(s=t)})),s},t.getCardNumberMaxLength=e=>({[r.CardBrand.Unknown]:16,[r.CardBrand.AMEX]:15,[r.CardBrand.VISA]:16,[r.CardBrand.MasterCard]:16,[r.CardBrand.JCB]:16,[r.CardBrand.UnionPay]:16}[e]),t.getCardCCVMaxLength=e=>e===r.CardBrand.AMEX?4:3,t.combineDefaultSetup=e=>{const t={fields:{number:{element:null,placeholder:"信用卡號"},expirationDate:{element:null,placeholder:"有效期限 MM/YY"},ccv:{element:null,placeholder:"背面末三碼"}},styles:{normal:{width:"100%",height:"40px",color:"#000000",borderColor:"#DDDDDD"},focus:{color:"#000000",borderColor:"#DDDDDD"},error:{color:"#FF5353",borderColor:"#FF5353"},success:{color:"#000000",borderColor:"#DDDDDD"}}},s=Object.assign(Object.assign({},e),{styles:e.styles?Object.assign({},e.styles):{}});return Object.keys(s.fields).filter((e=>!s.fields[e].placeholder)).forEach((e=>{s.fields[e].placeholder=t.fields[e].placeholder})),Object.keys(t.styles).forEach((e=>{const r=e;Object.keys(s.styles).includes(r)?s.styles[r]=Object.assign({},t.styles[r],s.styles[r]):s.styles[r]=t.styles[r]})),s},t.convertSetupStylesToCSSRule=e=>{const t=[];return Object.entries(e||{}).forEach((([e,s])=>{let r="input";if(r="normal"===e?"input":"focus"===e?"input:focus":"error"===e?"input.invalid":"success"===e?"input.valid":"",null==r?void 0:r.length){const a=Object.entries(s).map((([e,t])=>`${e.replace(/([A-Z]+)*([A-Z][a-z])/g,"$1-$2").toLowerCase()}:${t}`));t.push(`${r}{${a.join(";")}}`),"error"!==e&&"success"!==e||t.push(`${r}:focus{${a.join(";")}}`)}})),t}},615:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BaseField=void 0;const r=s(906),a=s(887),n=s(316),i=s(917),o=s(275),l=s(540);class d extends r.PostMessageEmitter{constructor(e){super(window,window.parent,"*"),this.params=e,this.status=n.FieldStatus.Normal,this.cardBrand=a.CardBrand.Unknown,this._errors=[],this._element=document.getElementById(`${e.type}-field`),this._element.placeholder=e.placeholder||"",this._element.addEventListener("blur",this.onBlur.bind(this)),this._element.addEventListener("input",this.onChange.bind(this)),this.createStyleSheet=this.createStyleSheet.bind(this),this.createStyleSheet(),this.getParentMessage=this.getParentMessage.bind(this),this.getParentMessage()}getParentMessage(){this.on("FOCUS_FIELD",(()=>this.element.focus())),this.on("SYNC_CLIENT",(e=>{o.Config.getInstance().clientData=e})),this.on("SYNC_CARD_BRAND",(e=>{this.cardBrand=e,"ccv"===this.params.type&&this.element.value.length&&(this.onChange(),this.changeElementStatus())})),this.on("GET_TOKEN",(e=>{(0,i.getTxnToken)(e).then((e=>{this.emit("GET_TOKEN_COMPLETED",e)}))}))}createStyleSheet(){const e=document.styleSheets[0];(0,l.convertSetupStylesToCSSRule)(this.params.styles||{}).forEach((t=>{e.insertRule(t,e.cssRules.length)}))}changeElementStatus(){this.status===n.FieldStatus.Normal&&(this.element.classList.remove("invalid"),this.element.classList.remove("valid")),this.status===n.FieldStatus.Success&&(this.element.classList.remove("invalid"),this.element.classList.add("valid")),this.status===n.FieldStatus.Error&&(this.element.classList.remove("valid"),this.element.classList.add("invalid"))}removeNotAllowedCharacter(){this.element.value=this.getUnformattedValue()}getUnformattedValue(){return this.element.value.replace(/\D/g,"")}formatValue(){this.element.value.length}afterValueFormated(){}validate(){if(!this.element.value.length)return this.status=n.FieldStatus.Normal,this.errors=[],void this.changeElementStatus();this.errors=[]}onBlur(){this.changeElementStatus()}onChange(){this.removeNotAllowedCharacter(),this.formatValue(),this.afterValueFormated(),this.validate();const e={type:this.params.type,status:this.status,value:this.getUnformattedValue(),errorMessage:this.errors[0]||""};this.emit("UPDATE_FIELD",e)}get element(){return this._element}set status(e){this._status=e}get status(){return this._status}get cardBrand(){return this._cardBrand}set cardBrand(e){this._cardBrand=e}set errors(e){this._errors=e}get errors(){return this._errors}}t.BaseField=d},38:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CCVField=void 0;const r=s(615),a=s(540),n=s(316);class i extends r.BaseField{constructor(e){super(e),this.params=e}validate(){super.validate(),this.element.value.length!==(0,a.getCardCCVMaxLength)(this.cardBrand)&&this.errors.push("未填寫完成或錯誤"),this.status=this.errors.length?n.FieldStatus.Error:n.FieldStatus.Success,this.element.value.length===(0,a.getCardCCVMaxLength)(this.cardBrand)&&this.changeElementStatus()}afterValueFormated(){this.element.setAttribute("maxlength",(0,a.getCardCCVMaxLength)(this.cardBrand).toString())}}t.CCVField=i},256:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ExpirationDateField=void 0;const r=s(615),a=s(316);class n extends r.BaseField{constructor(e){super(e),this.params=e}validate(){super.validate();const e=new Date,t=+e.getFullYear().toString().slice(2,4),s=+e.getFullYear().toString().slice(2,4)+30,r=this.getUnformattedValue().slice(0,2),n=this.getUnformattedValue().slice(2,4);if(2===r.length&&/(^0?[1-9]$)|(^1[0-2]$)/.test(r)||this.errors.push("月份錯誤"),4===this.getUnformattedValue().length){const e=new Date;e.setFullYear(+`${+(new Date).getFullYear().toString().slice(0,2)}${n}`),e.setMonth(+r-1),this.getDiffMonths(e)<0&&this.errors.push("已超過到期日")}2===n.length&&+n>=t&&+n<=s||this.errors.push("年份錯誤"),this.status=this.errors.length?a.FieldStatus.Error:a.FieldStatus.Success,4===this.getUnformattedValue().length&&this.changeElementStatus()}getDiffMonths(e){const t=new Date;return e.getMonth()-t.getMonth()+12*(e.getFullYear()-t.getFullYear())}formatValue(){super.formatValue();const e=this.getUnformattedValue().slice(0,4).match(/.{1,2}/g);this.element.value=e?e.join("/"):this.element.value}afterValueFormated(){this.element.setAttribute("maxlength","5")}}t.ExpirationDateField=n},724:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NumberField=void 0;const r=s(887),a=s(540),n=s(615),i=s(316);class o extends n.BaseField{constructor(e){super(e),this.params=e}validate(){super.validate();const e={[r.CardBrand.Unknown]:/^[0-9]{16}$/,[r.CardBrand.AMEX]:/^3[47][0-9]{13}$/,[r.CardBrand.VISA]:/^4[0-9]{15}$/,[r.CardBrand.MasterCard]:/^5[1-5][0-9]{14}$/,[r.CardBrand.JCB]:/^35[0-9]{14}$/,[r.CardBrand.UnionPay]:/^62[0-9]{14}$/};this.cardBrand===r.CardBrand.AMEX&&this.errors.push("暫不支援美國運通信用卡交易"),this.cardBrand===r.CardBrand.UnionPay&&this.errors.push("暫不支援銀聯信用卡交易"),e[this.cardBrand].test(this.getUnformattedValue())||this.errors.push("未填寫完成"),this.status=this.errors.length?i.FieldStatus.Error:i.FieldStatus.Success,this.getUnformattedValue().length===(0,a.getCardNumberMaxLength)(this.cardBrand)&&this.changeElementStatus()}formatValue(){const e=this.getUnformattedValue().match(/.{1,4}/g);this.element.value=e?e.join(" "):this.element.value}afterValueFormated(){this.cardBrand=(0,a.getCardBrand)(this.getUnformattedValue()),this.emit("UPDATE_CARD_BRAND",this.cardBrand);const e=(0,a.getCardNumberMaxLength)(this.cardBrand),t=Math.floor(e/4)-(e%4==0?1:0);this.element.setAttribute("maxlength",(e+t).toString())}}t.NumberField=o},316:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.FieldStatus=void 0,(s=t.FieldStatus||(t.FieldStatus={}))[s.Normal=0]="Normal",s[s.Success=1]="Success",s[s.Error=-1]="Error"},917:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(a,n){function i(e){try{l(r.next(e))}catch(e){n(e)}}function o(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(i,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getTxnToken=void 0;const a=s(275);t.getTxnToken=e=>r(void 0,void 0,void 0,(function*(){try{const t=`${a.Config.getInstance().apiDomain}/api/Payment/GetTxnToken`,s=yield fetch(t,{body:JSON.stringify(e),method:"POST",headers:{"content-type":"application/json"}});return Promise.resolve(s.json())}catch(e){return Promise.reject(e)}}))}},t={};function s(r){var a=t[r];if(void 0!==a)return a.exports;var n=t[r]={exports:{}};return e[r].call(n.exports,n,n.exports,s),n.exports}(()=>{const e=s(724),t=s(256),r=s(38);document.addEventListener("DOMContentLoaded",(()=>{if(!window.location.search.length)return;const s=JSON.parse(decodeURIComponent(window.location.search.replace("?","")));[].forEach.call(document.querySelectorAll("form"),(e=>{e.id!==`${s.type}-form`?e.remove():e.addEventListener("keydown",(e=>{"Enter"===e.key&&e.preventDefault()}))})),"number"===s.type&&new e.NumberField(s),"expirationDate"===s.type&&new t.ExpirationDateField(s),"ccv"===s.type&&new r.CCVField(s)}))})()})();
//# sourceMappingURL=index.js.map