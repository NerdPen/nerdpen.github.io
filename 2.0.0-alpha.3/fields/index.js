(()=>{"use strict";var e={275:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0;const a=s(374);class r extends a.EventEmitter{constructor(){super(),this._clientData=null,this._origin={sandbox:"https://gadget.payment.qa.91dev.tw",production:"https://gadget.payment.91app.com"}}static getInstance(){return r._instance||(r._instance=new r),r._instance}set clientData(e){this._clientData=Object.assign({},e)}get clientData(){return this._clientData}get version(){return"2.0.0-alpha.3"}get origin(){return this._origin[this.clientData.serverType]}get apiDomain(){return this._origin[this.clientData.serverType]}get iframeDomain(){return`./${this.version}`}}t.Config=r},374:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmitter=void 0,t.EventEmitter=class{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach((e=>{e(t)}))}off(e){this.listeners.has(e)&&this.listeners.delete(e)}}},906:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PostMessageEmitter=void 0,t.PostMessageEmitter=class{constructor(e,t,s){this.current=e,this.target=t,this.origin=s,this.listeners=new Map,this.current.addEventListener("message",(e=>{const{type:t,payload:s}=e.data;this.listeners.get(t)&&this.listeners.get(t).forEach((e=>{e(s)}))}))}on(e,t){this.listeners.get(e)||this.listeners.set(e,[t])}emit(e,t){const s={type:e,payload:t};this.target.postMessage(s,this.origin)}registerEvent(e){return t=>this.on(e,t)}}},887:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.CardBrand=void 0,(s=t.CardBrand||(t.CardBrand={})).Unknown="Unknown",s.MasterCard="MasterCard",s.VISA="VISA",s.JCB="JCB",s.AMEX="AMEX",s.UnionPay="UnionPay"},540:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getCardCCVMaxLength=t.getCardNumberMaxLength=t.getCardBrand=void 0;const a=s(887);t.getCardBrand=e=>{const t={[a.CardBrand.AMEX]:/^3[47]/,[a.CardBrand.VISA]:/^4/,[a.CardBrand.MasterCard]:/^5[1-5]/,[a.CardBrand.JCB]:/^35/,[a.CardBrand.UnionPay]:/^62/};let s=a.CardBrand.Unknown;return Object.entries(t).forEach((([t,a])=>{a.test(e)&&(s=t)})),s},t.getCardNumberMaxLength=e=>({[a.CardBrand.Unknown]:16,[a.CardBrand.AMEX]:15,[a.CardBrand.VISA]:16,[a.CardBrand.MasterCard]:16,[a.CardBrand.JCB]:16,[a.CardBrand.UnionPay]:16}[e]),t.getCardCCVMaxLength=e=>e===a.CardBrand.AMEX?4:3},615:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BaseField=void 0;const a=s(906),r=s(887),n=s(316),i=s(917),o=s(275);class d extends a.PostMessageEmitter{constructor(e){super(window,window.parent,"*"),this.params=e,this.status=n.FieldStatus.Normal,this.cardBrand=r.CardBrand.Unknown,this._errors=[],this._element=document.getElementById(`${e.type}-field`),this._element.placeholder=e.placeholder||"",this._element.addEventListener("foucs",this.onFocus.bind(this)),this._element.addEventListener("blur",this.onBlur.bind(this)),this._element.addEventListener("input",this.onChange.bind(this)),this.createStyleSheet=this.createStyleSheet.bind(this),this.createStyleSheet(),this.getParentMessage=this.getParentMessage.bind(this),this.getParentMessage()}getParentMessage(){this.on("FOCUS_FIELD",(()=>this.element.focus())),this.on("SYNC_CLIENT",(e=>{o.Config.getInstance().clientData=e})),this.on("SYNC_CARD_BRAND",(e=>{this.cardBrand=e,"ccv"===this.params.type&&this.element.value.length&&(this.onChange(null),this.changeElementStatus())})),this.on("GET_TOKEN",(e=>{(0,i.getTxnToken)(e).then((e=>{this.emit("GET_TOKEN_COMPLETED",e)}))}))}createStyleSheet(){const e=document.styleSheets[0];Object.entries(this.params.styles).forEach((([t,s])=>{const a=Object.entries(s).map((([e,t])=>`${e.replace(/([A-Z]+)*([A-Z][a-z])/g,"$1-$2").toLowerCase()}:${t}`));e.insertRule(`${t}{${a.join(";")}}`,e.cssRules.length)}))}changeElementStatus(){this.status===n.FieldStatus.Normal&&(this.element.classList.remove("invalid"),this.element.classList.remove("valid")),this.status===n.FieldStatus.Success&&(this.element.classList.remove("invalid"),this.element.classList.add("valid")),this.status===n.FieldStatus.Error&&(this.element.classList.remove("valid"),this.element.classList.add("invalid"))}removeNotAllowedCharacter(){this.element.value=this.getUnformattedValue()}getUnformattedValue(){return this.element.value.replace(/\D/g,"")}formatValue(){this.element.value.length}afterValueFormated(){}validate(){this.element.value.length?this.errors=[]:this.status=n.FieldStatus.Normal}onFocus(e){}onBlur(e){this.changeElementStatus()}onChange(e){this.removeNotAllowedCharacter(),this.formatValue(),this.afterValueFormated(),this.validate(),this.status=this.errors.length?n.FieldStatus.Error:n.FieldStatus.Success;const t={type:this.params.type,status:this.status,value:this.getUnformattedValue(),errorMessage:this.errors[0]||""};this.emit("UPDATE_FIELD",t)}get element(){return this._element}set status(e){this._status=e}get status(){return this._status}get cardBrand(){return this._cardBrand}set cardBrand(e){this._cardBrand=e}set errors(e){this._errors=e}get errors(){return this._errors}}t.BaseField=d},38:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CCVField=void 0;const a=s(615),r=s(540);class n extends a.BaseField{constructor(e){super(e),this.params=e}validate(){super.validate(),this.element.value.length!==(0,r.getCardCCVMaxLength)(this.cardBrand)&&this.errors.push("未填寫完成或錯誤")}afterValueFormated(){this.element.setAttribute("maxlength",(0,r.getCardCCVMaxLength)(this.cardBrand).toString()),this.getUnformattedValue().length===(0,r.getCardCCVMaxLength)(this.cardBrand)&&(this.validate(),this.changeElementStatus())}}t.CCVField=n},256:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ExpirationDateField=void 0;const a=s(615);class r extends a.BaseField{constructor(e){super(e),this.params=e}validate(){super.validate();const e=new Date,t=+e.getFullYear().toString().slice(2,4),s=+e.getFullYear().toString().slice(2,4)+30,a=this.getUnformattedValue().slice(0,2),r=this.getUnformattedValue().slice(2,4);if(2===a.length&&/(^0?[1-9]$)|(^1[0-2]$)/.test(a)||this.errors.push("月份錯誤"),4===this.getUnformattedValue().length){const e=new Date;e.setFullYear(+`${+(new Date).getFullYear().toString().slice(0,2)}${r}`),e.setMonth(+a-1),this.getDiffMonths(e)<0&&this.errors.push("已超過到期日")}2===r.length&&+r>=t&&+r<=s||this.errors.push("年份錯誤")}getDiffMonths(e){const t=new Date;return e.getMonth()-t.getMonth()+12*(e.getFullYear()-t.getFullYear())}formatValue(){super.formatValue();const e=this.getUnformattedValue().match(/.{1,2}/g);this.element.value=e?e.join("/"):this.element.value}afterValueFormated(){this.getUnformattedValue().length>=4&&(this.validate(),this.changeElementStatus())}}t.ExpirationDateField=r},724:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NumberField=void 0;const a=s(887),r=s(540),n=s(615);class i extends n.BaseField{constructor(e){super(e),this.params=e}validate(){super.validate();const e={[a.CardBrand.Unknown]:/^[0-9]{15,16}$/,[a.CardBrand.AMEX]:/^3[47][0-9]{13}$/,[a.CardBrand.VISA]:/^4[0-9]{15}$/,[a.CardBrand.MasterCard]:/^5[1-5][0-9]{14}$/,[a.CardBrand.JCB]:/^35[0-9]{14}$/,[a.CardBrand.UnionPay]:/^62[0-9]{14}$/};this.cardBrand===a.CardBrand.AMEX&&this.errors.push("暫不支援美國運通信用卡交易"),this.cardBrand===a.CardBrand.UnionPay&&this.errors.push("暫不支援銀聯信用卡交易"),e[this.cardBrand].test(this.getUnformattedValue())||this.errors.push("未填寫完成")}formatValue(){const e=this.getUnformattedValue().match(/.{1,4}/g);this.element.value=e?e.join(" "):this.element.value}afterValueFormated(){this.cardBrand=(0,r.getCardBrand)(this.getUnformattedValue()),this.emit("UPDATE_CARD_BRAND",this.cardBrand);const e=(0,r.getCardNumberMaxLength)(this.cardBrand),t=Math.floor(e/4)-(e%4==0?1:0);this.element.setAttribute("maxlength",(e+t).toString()),this.getUnformattedValue().length>=e&&(this.validate(),this.changeElementStatus())}}t.NumberField=i},316:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.FieldStatus=void 0,(s=t.FieldStatus||(t.FieldStatus={}))[s.Normal=0]="Normal",s[s.Success=1]="Success",s[s.Error=-1]="Error"},917:function(e,t,s){var a=this&&this.__awaiter||function(e,t,s,a){return new(s||(s=Promise))((function(r,n){function i(e){try{d(a.next(e))}catch(e){n(e)}}function o(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(i,o)}d((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getTxnToken=void 0;const r=s(275);t.getTxnToken=e=>a(void 0,void 0,void 0,(function*(){try{const t=`${r.Config.getInstance().apiDomain}/api/Payment/GetTxnToken`,s=yield fetch(t,{body:JSON.stringify(e),method:"POST",headers:{"content-type":"application/json"}});return Promise.resolve(s.json())}catch(e){return Promise.reject(e)}}))}},t={};function s(a){var r=t[a];if(void 0!==r)return r.exports;var n=t[a]={exports:{}};return e[a].call(n.exports,n,n.exports,s),n.exports}(()=>{const e=s(724),t=s(256),a=s(38);document.addEventListener("DOMContentLoaded",(()=>{if(!window.location.search.length)return;const s=JSON.parse(decodeURIComponent(window.location.search.replace("?","")));let r;[].forEach.call(document.querySelectorAll("form"),(e=>{e.id!==`${s.type}-form`?e.remove():e.addEventListener("keydown",(e=>{"Enter"===e.key&&e.preventDefault()}))})),"number"===s.type&&(r=new e.NumberField(s)),"expirationDate"===s.type&&(r=new t.ExpirationDateField(s)),"ccv"===s.type&&(r=new a.CCVField(s))}))})()})();
//# sourceMappingURL=index.js.map?t=3fc06a373a10b6fdab0a