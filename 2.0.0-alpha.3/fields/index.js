(()=>{"use strict";var e={275:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0;const a=s(374);class r extends a.EventEmitter{constructor(){super(),this._clientData=null,this._origin={sandbox:"https://gadget.payment.qa.91dev.tw",production:"https://gadget.payment.91app.com"}}static getInstance(){return r._instance||(r._instance=new r),r._instance}set clientData(e){this._clientData=Object.assign({},e)}get clientData(){return this._clientData}get version(){return"2.0.0-alpha.3"}get origin(){return this._origin[this.clientData.serverType]}get apiDomain(){return this._origin[this.clientData.serverType]}get iframeDomain(){return`./${this.version}`}}t.Config=r},374:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmitter=void 0,t.EventEmitter=class{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach((e=>{e(t)}))}off(e){this.listeners.has(e)&&this.listeners.delete(e)}}},906:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PostMessageEmitter=void 0,t.PostMessageEmitter=class{constructor(e,t,s){this.current=e,this.target=t,this.origin=s,this.listeners=new Map,this.current.addEventListener("message",(e=>{const{type:t,payload:s}=e.data;this.listeners.get(t)&&this.listeners.get(t).forEach((e=>{e(s)}))}))}on(e,t){this.listeners.get(e)||this.listeners.set(e,[t])}emit(e,t){const s={type:e,payload:t};this.target.postMessage(s,this.origin)}registerEvent(e){return t=>this.on(e,t)}}},887:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.CardBrand=void 0,(s=t.CardBrand||(t.CardBrand={})).Unknown="Unknown",s.MasterCard="MasterCard",s.VISA="VISA",s.JCB="JCB",s.AMEX="AMEX",s.UnionPay="UnionPay"},540:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getCardBrand=void 0;const a=s(887);t.getCardBrand=e=>{const t={[a.CardBrand.AMEX]:/^3[47][0-9]{13}$/,[a.CardBrand.VISA]:/^4/,[a.CardBrand.MasterCard]:/^5[1-5]/,[a.CardBrand.JCB]:/^35/,[a.CardBrand.UnionPay]:/^62/};let s=a.CardBrand.Unknown;return Object.keys(t).forEach((a=>{t[a].test(e)&&(s=a)})),s}},615:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BaseField=void 0;const a=s(906),r=s(887),n=s(316),i=s(917),o=s(275);class l extends a.PostMessageEmitter{constructor(e){super(window,window.parent,"*"),this.params=e,this._status=n.FieldStatus.Normal,this._cardBrand=r.CardBrand.Unknown;const t=`field-${e.type}`;this._element=document.getElementById(t),e.placeholder&&(this._element.placeholder=e.placeholder),this._element.addEventListener("foucs",this.onFocus.bind(this)),this._element.addEventListener("blur",this.onBlur.bind(this)),this._element.addEventListener("input",this.onChange.bind(this)),this.listenParentMessage()}listenParentMessage(){this.on("SYNC_CLIENT",(e=>{o.Config.getInstance().clientData=e})),this.on("SYNC_CARD_BRAND",(e=>{this.cardBrand=e})),this.on("GET_TOKEN",(e=>{(0,i.getTxnToken)(e).then((e=>{this.emit("GET_TOKEN_COMPLETED",e)}))}))}removeUnlegalCharacter(){/^[0-9\s/]+$/.test(this._element.value)||(this._element.value=this._element.value.slice(0,-1))}validate(){this.status===n.FieldStatus.Success&&(this.element.classList.remove("invalid"),this.element.classList.add("valid")),this.status===n.FieldStatus.Error&&(this.element.classList.remove("valid"),this.element.classList.add("invalid"))}getErrorMessage(){return""}getUnformattedValue(){return this.element.value}formatValue(){this.element.value.length}onFocus(e){}onBlur(e){}onChange(e){this.removeUnlegalCharacter(),this.validate(),this.formatValue();const t={type:this.params.type,status:this.status,value:this.getUnformattedValue(),errorMessage:this.getErrorMessage()};this.emit("UPDATE_FIELD",t)}get element(){return this._element}set status(e){this._status=e}get status(){return this._status}get cardBrand(){return this._cardBrand}set cardBrand(e){this._cardBrand=e}}t.BaseField=l},38:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CCVField=void 0;const a=s(887),r=s(316),n=s(615);class i extends n.BaseField{constructor(e){super(e),this.params=e}validate(){const e=this.cardBrand===a.CardBrand.AMEX?4:3;this.status=this.element.value.length===e?r.FieldStatus.Success:r.FieldStatus.Error,super.validate()}getErrorMessage(){return this.status===r.FieldStatus.Error?"背面末三碼未填或格式錯誤":""}}t.CCVField=i},256:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ExpirationDateField=void 0;const a=s(316),r=s(615);class n extends r.BaseField{constructor(e){super(e),this.params=e}validate(){const e=this.element.value.replace("/","").slice(0,2),t=this.element.value.replace("/","").slice(2,4),s=+(new Date).getFullYear().toString().slice(2,4),r=+(new Date).getFullYear().toString().slice(2,4)+30;this.status=/(^0?[1-9]$)|(^1[0-2]$)/.test(e)&&+t>=s&&+t<r?a.FieldStatus.Success:a.FieldStatus.Error,super.validate()}getErrorMessage(){return this.status===a.FieldStatus.Error?"有效期限未填或格式錯誤":""}formatValue(){super.formatValue();const e=this.element.value.replace("/","").slice(0,4).match(/.{1,2}/g);this.element.value=e?e.join("/"):this.element.value}getUnformattedValue(){return this.element.value.replace("/","")}}t.ExpirationDateField=n},724:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NumberField=void 0;const a=s(887),r=s(540),n=s(316),i=s(615);class o extends i.BaseField{constructor(e){super(e),this.params=e}validate(){const e={[a.CardBrand.Unknown]:/^[0-9]{18}$/,[a.CardBrand.AMEX]:/^3[47][0-9]{13}$/,[a.CardBrand.VISA]:/^4[0-9]{15}$/,[a.CardBrand.MasterCard]:/^5[1-5][0-9]{14}$/,[a.CardBrand.JCB]:/^35[0-9]{14}$/,[a.CardBrand.UnionPay]:/^62[0-9]{14,17}$/};this.status=e[this.cardBrand].test(this.element.value.replace(/\s/g,""))&&this.cardBrand!==a.CardBrand.UnionPay?n.FieldStatus.Success:n.FieldStatus.Error,super.validate()}getErrorMessage(){return this.cardBrand===a.CardBrand.UnionPay?"暫不支援此信用卡":this.status===n.FieldStatus.Error?"卡號未填或格式錯誤":""}formatValue(){super.formatValue();const e=this.element.value.replace(/\s/g,"").match(/.{1,4}/g);this.element.value=e?e.join(" "):this.element.value}getUnformattedValue(){return this.element.value.replace(/\s/g,"")}onChange(e){this.cardBrand=(0,r.getCardBrand)(e.target.value),this.emit("UPDATE_CARD_BRAND",this.cardBrand),super.onChange(e)}}t.NumberField=o},316:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.FieldStatus=void 0,(s=t.FieldStatus||(t.FieldStatus={}))[s.Normal=0]="Normal",s[s.Success=1]="Success",s[s.Error=-1]="Error"},917:function(e,t,s){var a=this&&this.__awaiter||function(e,t,s,a){return new(s||(s=Promise))((function(r,n){function i(e){try{l(a.next(e))}catch(e){n(e)}}function o(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(i,o)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getTxnToken=void 0;const r=s(275);t.getTxnToken=e=>a(void 0,void 0,void 0,(function*(){try{const t=`${r.Config.getInstance().apiDomain}/api/Payment/GetTxnToken`,s=yield fetch(t,{body:JSON.stringify(e),method:"POST",headers:{"content-type":"application/json"}});return Promise.resolve(s.json())}catch(e){return Promise.reject(e)}}))}},t={};function s(a){var r=t[a];if(void 0!==r)return r.exports;var n=t[a]={exports:{}};return e[a].call(n.exports,n,n.exports,s),n.exports}(()=>{const e=s(724),t=s(256),a=s(38);document.addEventListener("DOMContentLoaded",(()=>{if(!window.location.search.length)return;const s=JSON.parse(decodeURIComponent(window.location.search.replace("?","")));let r;[].forEach.call(document.querySelectorAll("form"),(e=>{e.id!==`${s.type}-form`&&e.remove()})),"number"===s.type&&(r=new e.NumberField(s)),"expirationDate"===s.type&&(r=new t.ExpirationDateField(s)),"ccv"===s.type&&(r=new a.CCVField(s))}))})()})();
//# sourceMappingURL=index.js.map?t=5d30a74661663be7b664