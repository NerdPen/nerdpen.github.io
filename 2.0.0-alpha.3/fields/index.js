(()=>{"use strict";var e={275:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0;const r=s(374);class a extends r.EventEmitter{constructor(){super(),this._clientData=null,this._origin={sandbox:"https://gadget.payment.qa.91dev.tw",production:"https://gadget.payment.91app.com"}}static getInstance(){return a._instance||(a._instance=new a),a._instance}set clientData(e){this._clientData=Object.assign({},e)}get clientData(){return this._clientData}get version(){return"2.0.0-alpha.3"}get origin(){return this._origin[this.clientData.serverType]}get apiDomain(){return this._origin[this.clientData.serverType]}get iframeDomain(){return`./${this.version}`}}t.Config=a},374:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmitter=void 0,t.EventEmitter=class{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach((e=>{e(t)}))}off(e){this.listeners.has(e)&&this.listeners.delete(e)}}},906:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PostMessageEmitter=void 0,t.PostMessageEmitter=class{constructor(e,t,s){this.current=e,this.target=t,this.origin=s,this.listeners=new Map,this.current.addEventListener("message",(e=>{const{type:t,payload:s}=e.data;this.listeners.get(t)&&this.listeners.get(t).forEach((e=>{e(s)}))}))}on(e,t){this.listeners.get(e)||this.listeners.set(e,[t])}emit(e,t){const s={type:e,payload:t};this.target.postMessage(s,this.origin)}registerEvent(e){return t=>this.on(e,t)}}},887:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.CardBrand=void 0,(s=t.CardBrand||(t.CardBrand={})).Unknown="Unknown",s.MasterCard="MasterCard",s.VISA="VISA",s.JCB="JCB",s.AMEX="AMEX",s.UnionPay="UnionPay"},540:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getCardBrand=void 0;const r=s(887);t.getCardBrand=e=>{const t={[r.CardBrand.AMEX]:/^3[47]/,[r.CardBrand.VISA]:/^4/,[r.CardBrand.MasterCard]:/^5[1-5]/,[r.CardBrand.JCB]:/^35/,[r.CardBrand.UnionPay]:/^62/};let s=r.CardBrand.Unknown;return Object.keys(t).forEach((r=>{t[r].test(e)&&(s=r)})),s}},615:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BaseField=void 0;const r=s(906),a=s(887),n=s(316),i=s(917),l=s(275);class o extends r.PostMessageEmitter{constructor(e){super(window,window.parent,"*"),this.params=e,this._status=n.FieldStatus.Normal,this._cardBrand=a.CardBrand.Unknown,this._errorMessage="",this.createStyleSheet=this.createStyleSheet.bind(this);const t=`field-${e.type}`;this._element=document.getElementById(t),e.placeholder&&(this._element.placeholder=e.placeholder),this._element.addEventListener("foucs",this.onFocus.bind(this)),this._element.addEventListener("blur",this.onBlur.bind(this)),this._element.addEventListener("input",this.onChange.bind(this)),this.listenParentMessage(),this.createStyleSheet()}listenParentMessage(){this.on("FOCUS_FIELD",(()=>this.element.focus())),this.on("SYNC_CLIENT",(e=>{l.Config.getInstance().clientData=e})),this.on("SYNC_CARD_BRAND",(e=>{this.cardBrand=e})),this.on("GET_TOKEN",(e=>{(0,i.getTxnToken)(e).then((e=>{this.emit("GET_TOKEN_COMPLETED",e)}))}))}createStyleSheet(){const e=document.styleSheets[0];Object.entries(this.params.styles).forEach((([t,s])=>{const r=Object.entries(s).map((([e,t])=>`${e.replace(/([A-Z]+)*([A-Z][a-z])/g,"$1-$2").toLowerCase()}:${t}`));e.insertRule(`${t}{${r.join(";")}}`,e.cssRules.length)}))}removeUnlegalCharacter(){/^[0-9\s/]+$/.test(this._element.value)||(this._element.value=this._element.value.slice(0,-1))}validate(){this.status===n.FieldStatus.Normal&&(this.element.classList.remove("invalid"),this.element.classList.remove("valid")),this.status===n.FieldStatus.Success&&(this.element.classList.remove("invalid"),this.element.classList.add("valid")),this.status===n.FieldStatus.Error&&(this.element.classList.remove("valid"),this.element.classList.add("invalid"))}getUnformattedValue(){return this.element.value}formatValue(){this.element.value.length}onFocus(e){}onBlur(e){}onChange(e){this.removeUnlegalCharacter(),this.validate(),this.formatValue();const t={type:this.params.type,status:this.status,value:this.getUnformattedValue(),errorMessage:this.errorMessage};this.emit("UPDATE_FIELD",t)}get element(){return this._element}set status(e){this._status=e}get status(){return this._status}get cardBrand(){return this._cardBrand}set cardBrand(e){this._cardBrand=e}set errorMessage(e){this._errorMessage=e}get errorMessage(){return this.status===n.FieldStatus.Error?this._errorMessage:""}}t.BaseField=o},38:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CCVField=void 0;const r=s(887),a=s(316),n=s(615);class i extends n.BaseField{constructor(e){super(e),this.params=e}validate(){const e=this.cardBrand===r.CardBrand.AMEX?4:3;this.element.value.length?this.status=this.element.value.length===e?a.FieldStatus.Success:a.FieldStatus.Error:this.status=a.FieldStatus.Normal,this.status===a.FieldStatus.Error&&(this.errorMessage="未填寫完成"),super.validate()}}t.CCVField=i},256:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ExpirationDateField=void 0;const r=s(316),a=s(615);class n extends a.BaseField{constructor(e){super(e),this.params=e}validate(){if(this.getUnformattedValue().length){const e=new Date,t=/(^0?[1-9]$)|(^1[0-2]$)/,s=+e.getFullYear().toString().slice(2,4),a=+e.getFullYear().toString().slice(2,4)+30,n=this.element.value.replace("/","").slice(0,2),i=this.element.value.replace("/","").slice(2,4),l=2===n.length&&t.test(n),o=2===i.length&&+i>=s&&+i<a;if(this.status=l&&o?r.FieldStatus.Success:r.FieldStatus.Error,this.status===r.FieldStatus.Error&&(this.errorMessage="未填寫完成",o||(this.errorMessage="年份錯誤"),l||(this.errorMessage="月份錯誤")),4===this.getUnformattedValue().length){const e=new Date;e.setFullYear(+`${+(new Date).getFullYear().toString().slice(0,2)}${i}`),e.setMonth(+n-1),this.getDiffMonths(e)<0&&(this.status=r.FieldStatus.Error,this.errorMessage="已超過到期日")}}else this.status=r.FieldStatus.Normal;super.validate()}getDiffMonths(e){const t=new Date;return e.getMonth()-t.getMonth()+12*(e.getFullYear()-t.getFullYear())}formatValue(){super.formatValue();const e=this.element.value.replace("/","").slice(0,4).match(/.{1,2}/g);this.element.value=e?e.join("/"):this.element.value}getUnformattedValue(){return this.element.value.replace("/","")}}t.ExpirationDateField=n},724:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NumberField=void 0;const r=s(887),a=s(540),n=s(316),i=s(615);class l extends i.BaseField{constructor(e){super(e),this.params=e}validate(){const e={[r.CardBrand.Unknown]:/^[0-9]{18}$/,[r.CardBrand.AMEX]:/^3[47][0-9]{13}$/,[r.CardBrand.VISA]:/^4[0-9]{15}$/,[r.CardBrand.MasterCard]:/^5[1-5][0-9]{14}$/,[r.CardBrand.JCB]:/^35[0-9]{14}$/,[r.CardBrand.UnionPay]:/^62[0-9]{14,17}$/};this.element.value.length?(this.status=e[this.cardBrand].test(this.element.value.replace(/\s/g,""))&&this.cardBrand!==r.CardBrand.AMEX&&this.cardBrand!==r.CardBrand.UnionPay?n.FieldStatus.Success:n.FieldStatus.Error,this.status===n.FieldStatus.Error&&(this.errorMessage="未填寫完成",this.cardBrand===r.CardBrand.UnionPay&&(this.errorMessage="暫不支援銀聯信用卡交易"),this.cardBrand===r.CardBrand.AMEX&&(this.errorMessage="暫不支援美國運通信用卡交易"))):this.status=n.FieldStatus.Normal,super.validate()}formatValue(){super.formatValue();const e=this.element.value.replace(/\s/g,"").match(/.{1,4}/g);this.element.value=e?e.join(" "):this.element.value}getUnformattedValue(){return this.element.value.replace(/\s/g,"")}onChange(e){this.cardBrand=(0,a.getCardBrand)(e.target.value),this.emit("UPDATE_CARD_BRAND",this.cardBrand),super.onChange(e)}}t.NumberField=l},316:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.FieldStatus=void 0,(s=t.FieldStatus||(t.FieldStatus={}))[s.Normal=0]="Normal",s[s.Success=1]="Success",s[s.Error=-1]="Error"},917:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(a,n){function i(e){try{o(r.next(e))}catch(e){n(e)}}function l(e){try{o(r.throw(e))}catch(e){n(e)}}function o(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(i,l)}o((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getTxnToken=void 0;const a=s(275);t.getTxnToken=e=>r(void 0,void 0,void 0,(function*(){try{const t=`${a.Config.getInstance().apiDomain}/api/Payment/GetTxnToken`,s=yield fetch(t,{body:JSON.stringify(e),method:"POST",headers:{"content-type":"application/json"}});return Promise.resolve(s.json())}catch(e){return Promise.reject(e)}}))}},t={};function s(r){var a=t[r];if(void 0!==a)return a.exports;var n=t[r]={exports:{}};return e[r].call(n.exports,n,n.exports,s),n.exports}(()=>{const e=s(724),t=s(256),r=s(38);document.addEventListener("DOMContentLoaded",(()=>{if(!window.location.search.length)return;const s=JSON.parse(decodeURIComponent(window.location.search.replace("?","")));let a;[].forEach.call(document.querySelectorAll("form"),(e=>{e.id!==`${s.type}-form`&&e.remove()})),"number"===s.type&&(a=new e.NumberField(s)),"expirationDate"===s.type&&(a=new t.ExpirationDateField(s)),"ccv"===s.type&&(a=new r.CCVField(s))}))})()})();
//# sourceMappingURL=index.js.map?t=779761c218e2ba05d9e1