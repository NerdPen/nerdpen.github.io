(()=>{"use strict";var e={275:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0;const a=s(374);class i extends a.EventEmitter{constructor(){super(),this._clientData=null,this._origin={sandbox:"https://gadget.payment.qa.91dev.tw",production:"https://gadget.payment.91app.com"}}static getInstance(){return i._instance||(i._instance=new i),i._instance}set clientData(e){this._clientData=Object.assign({},e)}get clientData(){return this._clientData}get version(){return"2.0.0-alpha.3"}get origin(){return this._origin[this.clientData.serverType]}get apiDomain(){return this._origin[this.clientData.serverType]}get iframeDomain(){return`./${this.version}`}}t.Config=i},374:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmitter=void 0,t.EventEmitter=class{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach((e=>{e(t)}))}off(e){this.listeners.has(e)&&this.listeners.delete(e)}}},906:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PostMessageEmitter=void 0,t.PostMessageEmitter=class{constructor(e,t,s){this.current=e,this.target=t,this.origin=s,this.listeners=new Map,this.current.addEventListener("message",(e=>{const{type:t,payload:s}=e.data;this.listeners.get(t)&&this.listeners.get(t).forEach((e=>{e(s)}))}))}on(e,t){this.listeners.get(e)||this.listeners.set(e,[t])}emit(e,t){const s={type:e,payload:t};this.target.postMessage(s,this.origin)}registerEvent(e){return t=>this.on(e,t)}}},403:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CCV=void 0;const a=s(275),i=s(374),r=s(887),n=s(540),d=s(843),o=s(316),l=s(432),c=new WeakMap;class u extends i.EventEmitter{constructor(){super(),c.set(this,{config:null,updateData:{canGetToken:!1,cardBrand:r.CardBrand.Unknown,fields:{ccv:{target:null,status:o.FieldStatus.Normal,value:"",errorMessage:""}}}}),this.setup=this.setup.bind(this),this.setupCardBrand=this.setupCardBrand.bind(this)}setup(e){if(!a.Config.getInstance().clientData)throw new Error("[SDK] please run SDK.setupSDK(appId, appKey, serverType) first.");if(!(0,d.isSetupCCVFieldsVaild)(e.fields))throw new Error("[SDK] setup field element is incorrect");e.styles&&Object.entries(e.styles).forEach((([e,t])=>{if(!(0,d.isSetupStyleTypeVaild)(e))throw new Error(`[SDK] setup style type "${e}" is not allowed.`);Object.keys(t).forEach((t=>{if(!(0,d.isSetupCSSStyleVaild)(e,t))throw new Error(`[SDK] setup css style "${t}" is not allowed.`)}))})),c.get(this).config=(0,n.combineDefaultSetup)(e),this.createFields()}createFields(){const e=c.get(this).config.fields.ccv,t={type:"ccv",placeholder:e.placeholder,styles:c.get(this).config.styles},s=document.createElement("iframe");this.getParentElement(e.element).appendChild(s),s.src=`${a.Config.getInstance().iframeDomain}/fields/index.html?${encodeURIComponent(JSON.stringify(t))}`,s.width=c.get(this).config.styles.normal.width,s.height=c.get(this).config.styles.normal.height,s.addEventListener("load",(()=>{c.get(this).updateData.fields.ccv.target.emit("SYNC_CLIENT",a.Config.getInstance().clientData),c.get(this).updateData.fields.ccv.target.emit("SYNC_CARD_BRAND",c.get(this).updateData.cardBrand)}));const i=new l.FieldFrame(s);c.get(this).updateData.fields.ccv.target=i,i.onUpdate((e=>{c.get(this).updateData=Object.assign(Object.assign({},c.get(this).updateData),{canGetToken:e.status!==o.FieldStatus.Error,fields:{ccv:Object.assign(Object.assign({},c.get(this).updateData.fields.ccv),{status:e.status,value:e.value,errorMessage:e.errorMessage})}}),this.emit("UPDATE",Object.assign(Object.assign({},c.get(this).updateData),{fields:{ccv:{status:e.status,errorMessage:e.errorMessage}}}))}))}getParentElement(e){return"string"==typeof e?document.querySelector(e.toString()):e}setupCardBrand(e){c.get(this).updateData.cardBrand=e,c.get(this).updateData.fields.ccv.target.emit("SYNC_CARD_BRAND",c.get(this).updateData.cardBrand)}onUpdate(e){return this.on("UPDATE",(t=>{e(t)}))}}t.CCV=u},887:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.CardBrand=void 0,(s=t.CardBrand||(t.CardBrand={})).Unknown="Unknown",s.MasterCard="MasterCard",s.VISA="VISA",s.JCB="JCB",s.AMEX="AMEX",s.UnionPay="UnionPay"},252:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CreditCard=void 0;const a=s(374),i=s(432),r=s(316),n=s(887),d=s(275),o=s(843),l=s(540),c=new WeakMap;class u extends a.EventEmitter{constructor(){super(),c.set(this,{config:null,updateData:{canGetToken:!1,cardBrand:n.CardBrand.Unknown,fields:{number:null,expirationDate:null,ccv:null}}}),Object.keys(c.get(this).updateData.fields).forEach((e=>{c.get(this).updateData.fields[e]={target:null,status:r.FieldStatus.Normal,value:"",errorMessage:""}})),this.setup=this.setup.bind(this),this.getToken=this.getToken.bind(this)}setup(e){if(!d.Config.getInstance().clientData)throw new Error("[SDK] please run SDK.setupSDK(appId, appKey, serverType) first.");if(!(0,o.isFieldsConfigVaild)(e.fields))throw new Error("[SDK] setup field element is incorrect");e.styles&&Object.entries(e.styles).forEach((([e,t])=>{if(!(0,o.isSetupStyleTypeVaild)(e))throw new Error(`[SDK] setup style type "${e}" is not allowed.`);Object.keys(t).forEach((t=>{if(!(0,o.isSetupCSSStyleVaild)(e,t))throw new Error(`[SDK] setup css style "${t}" is not allowed.`)}))})),c.get(this).config=(0,l.combineDefaultSetup)(e),this.createFields()}createFields(){Object.keys(c.get(this).config.fields).forEach((e=>{const t=e,s=c.get(this).config.fields[t],a={type:t,placeholder:s.placeholder,styles:c.get(this).config.styles},n=document.createElement("iframe");this.getParentElement(s.element).appendChild(n),n.src=`${d.Config.getInstance().iframeDomain}/fields/index.html?${encodeURIComponent(JSON.stringify(a))}`,n.width=c.get(this).config.styles.normal.width,n.height=c.get(this).config.styles.normal.height,n.addEventListener("load",(()=>{c.get(this).updateData.fields.ccv.target.emit("SYNC_CLIENT",d.Config.getInstance().clientData)}));const o=new i.FieldFrame(n);c.get(this).updateData.fields[t].target=o,o.onUpdateCardBrand((e=>{c.get(this).updateData.cardBrand=e,"number"!==t&&o.emit("SYNC_CARD_BRAND",e)})),o.onUpdate((e=>{c.get(this).updateData=Object.assign(Object.assign({},c.get(this).updateData),{fields:Object.assign(Object.assign({},c.get(this).updateData.fields),{[e.type]:Object.assign(Object.assign({},c.get(this).updateData.fields[e.type]),{status:e.status,value:e.value,errorMessage:e.errorMessage})})}),c.get(this).updateData.canGetToken=void 0===Object.values(c.get(this).updateData.fields).find((e=>e.status!==r.FieldStatus.Success));const s=Object.assign(Object.assign({},c.get(this).updateData),{fields:{number:{status:c.get(this).updateData.fields.number.status,errorMessage:c.get(this).updateData.fields.number.errorMessage},expirationDate:{status:c.get(this).updateData.fields.expirationDate.status,errorMessage:c.get(this).updateData.fields.expirationDate.errorMessage},ccv:{status:c.get(this).updateData.fields.ccv.status,errorMessage:c.get(this).updateData.fields.ccv.errorMessage}}});"number"===t&&this.emit("UPDATE",s),this.focusToNextField(e.type)}))}))}getParentElement(e){return"string"==typeof e?document.querySelector(e.toString()):e}focusToNextField(e){if(c.get(this).updateData.fields[e].status===r.FieldStatus.Success){const t=Object.keys(c.get(this).updateData.fields).findIndex((t=>t===e));Object.values(c.get(this).updateData.fields).forEach(((e,s)=>{s===t+1&&e.target.emit("FOCUS_FIELD")}))}}getFieldData(e){return c.get(this).updateData.fields[e]}getToken(e){const t={appId:d.Config.getInstance().clientData.appId.toString(),appKey:d.Config.getInstance().clientData.appKey,sdkVer:d.Config.getInstance().version,cardNumber:this.getFieldData("number").value,cardExpiryDate:this.getFieldData("expirationDate").value,cardSecurityCode:this.getFieldData("ccv").value};this.getFieldData("number").target.onGetTokenCompleted((t=>{e(t)})),this.getFieldData("number").target.emit("GET_TOKEN",t)}onUpdate(e){return this.on("UPDATE",(t=>{e(t)}))}}t.CreditCard=u},540:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.convertSetupStylesToCSSRule=t.combineDefaultSetup=t.getCardCCVMaxLength=t.getCardNumberMaxLength=t.getCardBrand=void 0;const a=s(887);t.getCardBrand=e=>{const t={[a.CardBrand.AMEX]:/^3[47]/,[a.CardBrand.VISA]:/^4/,[a.CardBrand.MasterCard]:/^5[1-5]/,[a.CardBrand.JCB]:/^35/,[a.CardBrand.UnionPay]:/^62/};let s=a.CardBrand.Unknown;return Object.entries(t).forEach((([t,a])=>{a.test(e)&&(s=t)})),s},t.getCardNumberMaxLength=e=>({[a.CardBrand.Unknown]:16,[a.CardBrand.AMEX]:15,[a.CardBrand.VISA]:16,[a.CardBrand.MasterCard]:16,[a.CardBrand.JCB]:16,[a.CardBrand.UnionPay]:16}[e]),t.getCardCCVMaxLength=e=>e===a.CardBrand.AMEX?4:3,t.combineDefaultSetup=e=>{const t={fields:{number:{element:null,placeholder:"信用卡號"},expirationDate:{element:null,placeholder:"有效期限 MM/YY"},ccv:{element:null,placeholder:"背面末三碼"}},styles:{normal:{width:"100%",height:"40px",color:"#000000",borderColor:"#DDDDDD"},focus:{color:"#000000",borderColor:"#DDDDDD"},error:{color:"#FF5353",borderColor:"#FF5353"},success:{color:"#000000",borderColor:"#DDDDDD"}}},s=Object.assign(Object.assign({},e),{styles:e.styles?Object.assign({},e.styles):{}});return Object.keys(s.fields).filter((e=>!s.fields[e].placeholder)).forEach((e=>{s.fields[e].placeholder=t.fields[e].placeholder})),Object.keys(t.styles).forEach((e=>{const a=e;Object.keys(s.styles).includes(a)?s.styles[a]=Object.assign({},t.styles[a],s.styles[a]):s.styles[a]=t.styles[a]})),s},t.convertSetupStylesToCSSRule=e=>{const t=[];return Object.entries(e||{}).forEach((([e,s])=>{let a="input";if(a="normal"===e?"input":"focus"===e?"input:focus":"error"===e?"input.invalid":"success"===e?"input.valid":"",null==a?void 0:a.length){const i=Object.entries(s).map((([e,t])=>`${e.replace(/([A-Z]+)*([A-Z][a-z])/g,"$1-$2").toLowerCase()}:${t}`));t.push(`${a}{${i.join(";")}}`),"error"!==e&&"success"!==e||t.push(`${a}:focus{${i.join(";")}}`)}})),t}},843:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isSetupCSSStyleVaild=t.isSetupStyleTypeVaild=t.isSetupCCVFieldsVaild=t.isFieldsConfigVaild=void 0,t.isFieldsConfigVaild=e=>e&&void 0===Object.values(e).find((e=>!e.element||"string"!=typeof e.element&&!(e.element instanceof HTMLElement))),t.isSetupCCVFieldsVaild=e=>e&&1===Object.keys(e).length&&void 0===Object.keys(e).find((e=>"ccv"!==e))&&void 0===Object.values(e).find((e=>!e.element||"string"!=typeof e.element&&!(e.element instanceof HTMLElement))),t.isSetupStyleTypeVaild=e=>["normal","focus","error","success"].includes(e),t.isSetupCSSStyleVaild=(e,t)=>("normal"===e?["width","height","borderColor","color"]:["borderColor","color"]).includes(t)},316:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.FieldStatus=void 0,(s=t.FieldStatus||(t.FieldStatus={}))[s.Normal=0]="Normal",s[s.Success=1]="Success",s[s.Error=-1]="Error"},432:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FieldFrame=void 0;const a=s(906);class i extends a.PostMessageEmitter{constructor(e){super(window,e.contentWindow,"*"),this.element=e,this.onUpdate=this.onUpdate.bind(this),this.onUpdateCardBrand=this.onUpdateCardBrand.bind(this),this.onGetTokenCompleted=this.onGetTokenCompleted.bind(this),this.element.setAttribute("scrolling","no"),this.element.setAttribute("frameborder","0"),this.element.setAttribute("allowtransparency","true"),this.element.setAttribute("width","100%")}onUpdate(e){return this.on("UPDATE_FIELD",(t=>{e(t)}))}onUpdateCardBrand(e){return this.on("UPDATE_CARD_BRAND",(t=>{e(t)}))}onGetTokenCompleted(e){return this.on("GET_TOKEN_COMPLETED",(t=>{e(t)}))}}t.FieldFrame=i}},t={};function s(a){var i=t[a];if(void 0!==i)return i.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,s),r.exports}(()=>{const e=s(275),t=s(252),a=s(403),i=new WeakMap;window.PaymentSDK=new class{constructor(){this.setupSDK=(e,t,s)=>{i.get(this).config.clientData={appId:e,appKey:t,serverType:s}},i.set(this,{config:e.Config.getInstance(),card:null,ccv:null}),this.setupSDK=this.setupSDK.bind(this)}get card(){return i.get(this).card||(i.get(this).card=new t.CreditCard),i.get(this).card}get ccv(){return i.get(this).ccv||(i.get(this).ccv=new a.CCV),i.get(this).ccv}}})()})();
//# sourceMappingURL=index.js.map